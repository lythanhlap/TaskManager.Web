@using TaskManager.Projects.Abstractions
@using System.Security.Claims
@model IEnumerable<ProjectDto>
@{
    Layout = null;
}

@{
    ViewData["Title"] = "Bảng điều khiển";
    var userName = User?.Identity?.Name ?? "Khách";
    var fullName = User?.FindFirst("name")?.Value ?? userName;

    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier)
                 ?? User.FindFirst("sub")?.Value
                 ?? string.Empty;

    var username = User.FindFirstValue("username")
                ?? User.FindFirstValue("name")
                ?? User.Identity?.Name
                ?? "User";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f3f6fb;
            color: #1f2937;
        }

        /* Header */
        .app__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 28px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 6px rgba(0,0,0,.05);
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: #2563eb;
        }

        .search input {
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            outline: none;
            width: 260px;
        }

            .search input:focus {
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37,99,235,.2);
            }

        /* Account */
        .account-menu {
            position: relative;
        }

        .account-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #2563eb;
        }

        .account-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,.15);
            display: none;
            flex-direction: column;
            min-width: 200px;
            z-index: 1000;
        }

            .account-dropdown a, .account-dropdown button {
                padding: 10px 16px;
                text-align: left;
                border: none;
                background: none;
                font-size: 14px;
                color: #374151;
                border-bottom: 1px solid #f3f4f6;
                width: 100%;
                text-decoration: none; /* bỏ gạch chân */
            }

                .account-dropdown a:hover, .account-dropdown button:hover {
                    background: #f9fafb;
                    color: #2563eb;
                }

        /* Layout */
        .app__body {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            padding: 24px;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.05);
            padding: 24px;
        }

            .sidebar a {
                display: block;
                margin-bottom: 20px;
                font-weight: 700;
                font-size: 18px;
                color: #374151;
                text-decoration: none;
                padding: 8px 4px;
            }

                .sidebar a:hover {
                    color: #2563eb;
                }

        /* Banner */
        .banner {
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            border-radius: 12px;
            padding: 28px;
            color: white;
            margin-bottom: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .banner h1 {
                margin: 0;
                font-size: 26px;
                font-weight: 700;
            }

            .banner p {
                margin: 6px 0 0;
                font-size: 16px;
            }

        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
            gap: 20px;
        }

        .card {
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform .2s, box-shadow .2s;
            text-decoration: none;
        }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 14px rgba(0,0,0,.08);
            }

        .card-body {
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

            .card-body small {
                display: block;
                margin-top: 6px;
                color: #6b7280;
            }

        .progress-rail {
            height: 12px;
            background: #e5e7eb;
            border-radius: 8px;
            margin: 0 16px 16px;
            position: relative;
            overflow: hidden;
        }

        .progress-rail__bar {
            height: 100%;
            background: #22c55e;
            transition: width .3s ease;
        }

        .progress-rail__label {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #111827;
        }

        .card--new {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            font-weight: 600;
            color: #6b7280;
        }

            .card--new:hover {
                background: #e5e7eb;
                color: #111827;
            }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin: 24px 0 16px;
        }
    </style>
</head>
<body>
    <header class="app__header">
        <div class="logo">Task Manager</div>
        <div class="search"><input type="search" placeholder="🔍 Tìm kiếm..." /></div>
        <div class="account">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="account-menu">
                    <img src="https://ui-avatars.com/api/?name=@username&background=2563eb&color=fff&rounded=true&size=38"
                         alt="Avatar @username" class="account-avatar" id="accountToggle" />
                    <div class="account-dropdown" id="accountDropdown">
                        <a asp-controller="Account" asp-action="Profile">👤 Thông tin tài khoản</a>
                        <a asp-controller="Account" asp-action="ChangePassword">🔑 Đổi mật khẩu</a>
                        <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                            @Html.AntiForgeryToken()
                            <button type="submit">🚪 Đăng xuất</button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <a asp-controller="Account" asp-action="Login" class="btn btn-light">Đăng nhập</a>
                <a asp-controller="Account" asp-action="Register" class="btn btn-primary">Đăng ký</a>
            }
        </div>
    </header>

    <div class="app__body">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a asp-controller="Home" asp-action="Index">🏠 Trang chủ</a>
            <a asp-controller="Projects" asp-action="Index">📁 Dự án</a>
            <a asp-controller="Reports" asp-action="Portfolio">📊 Tiến độ</a>
            <a asp-controller="Account" asp-action="Profile">⚙️ Tài khoản</a>
        </aside>

        <!-- Main -->
        <main class="main">
            <div class="banner">
                <div>
                    <h1>Xin chào, @fullName 👋</h1>
                    <p id="today"></p>
                    <small class="d-block mt-2">Bạn có <b>@(Model?.Count() ?? 0) dự án</b> đang quản lý</small>
                </div>
                <img src="https://ui-avatars.com/api/?name=@fullName&background=9333ea&color=fff&rounded=true&size=72"
                     class="rounded-circle shadow" />
            </div>

            <div class="section-title">📌 Dự án của bạn</div>
            <section class="cards">
                @if (Model != null && Model.Any())
                {
                    foreach (var p in Model)
                    {
                        <a class="card" href="/projects/@p.Id" data-project-id="@p.Id">
                            <div class="card-body">
                                📁 @p.Name
                                <small>Bắt đầu: @(p.StartDate?.ToString("dd/MM/yyyy") ?? "-")</small>
                            </div>
                            <div class="progress-rail" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-rail__bar" style="width:0%"></div>
                                <span class="progress-rail__label">0%</span>
                            </div>
                        </a>
                    }
                }
                else
                {
                    <div class="card card--new">Chưa có dự án</div>
                }
                <a class="card card--new" href="/projects/create">➕ Tạo dự án mới</a>
            </section>
        </main>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById("today").textContent =
          new Date().toLocaleDateString("vi-VN", { weekday:"long", day:"numeric", month:"long" });

        const toggle = document.getElementById("accountToggle");
        const dropdown = document.getElementById("accountDropdown");
        if (toggle && dropdown) {
          toggle.addEventListener("click", () => {
            dropdown.style.display = dropdown.style.display === "flex" ? "none" : "flex";
          });
          document.addEventListener("click", (e) => {
            if (!toggle.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
          });
        }

        // Tiến độ dự án
        (async function(){
          const res = await fetch('/api/reports/portfolio', { credentials:'same-origin' });
          if(!res.ok) return;
          const data = await res.json();
          const map = new Map(data.items.map(i => [String(i.projectId).toLowerCase(), i]));

          document.querySelectorAll('.card[data-project-id]').forEach(card=>{
            const id  = (card.getAttribute('data-project-id')||'').toLowerCase();
            const itm = map.get(id);
            if(!itm) return;

            const completed = itm.completedCount|0;
            const pending   = itm.pendingCount|0;
            const total     = completed + pending;
            const pct       = total ? (completed*100/total) : 0;

            const bar   = card.querySelector('.progress-rail__bar');
            const label = card.querySelector('.progress-rail__label');

            if(bar) bar.style.width = pct.toFixed(2) + '%';
            if(label){
              label.textContent = pct.toFixed(0) + '%';
              label.style.color = (pct >= 55) ? '#fff' : '#111827';
            }
            if(bar){
              bar.style.background = pct >= 80 ? '#16a34a'
                                  : pct >= 40 ? '#22c55e'
                                              : '#f97316';
            }
          });
        })();
    </script>
</body>
</html>
